#!/usr/bin/env bash

# Bash pragmas
set -o errexit
set -o pipefail
set -o nounset

# Where I am
BIN_DIR="$(cd $(dirname $(readlink -f "${BASH_SOURCE[0]}")) && pwd)"

# Load common lib
source "$BIN_DIR/../lib/freddie_common"

# My name
SCRIPT_NAME="${0##*/}"

# Command name
CMD_NAME="${SCRIPT_NAME#${PROG_NAME}_}"

# Dep files: string
STRING_MERGE_GTF="string/merge.gtf"

# Dep files: chimeric
CHIMERIC_MOST_SHARED_TSV="chimeric/most_shared.tsv"
CHIMERIC_INFO_TSV="chimeric/info.tsv"

# Dep files: coding
CODING_CLASSIFICATION_TSV="coding/classification.tsv"

# Dep files: pfam
PFAM_INFO_DOM_TSV="pfam/info_dom.tsv"

# Dep files: expression
EXPRESSION_EXPRESSION_TSV="expression/expression.tsv"

usage() {
	echo "$PROG_NAME $VERSION"
	echo "$PROG_NAME $CMD_NAME (aka $SCRIPT_NAME)"
	echo "Usage: $PROG_NAME $CMD_NAME [options]"
}

validate_opt() {
	# Mandatory options '-o'
	if [[ -z "$output_dir" ]]; then
		error "Missing '-o' option\n$(try_help)"
	elif [[ ! -d "$output_dir" ]]; then
		error "No such dir '$output_dir'.\nStart" \
			"your analysis from '$PROG_NAME string'"
	fi
}

validate_dep() {
	# string
	if [[ ! -f "$string_merge_gtf" ]]; then
		error "'$string_merge_gtf' not found.\nMaybe" \
			"you need to run '$PROG_NAME string' before"
	fi

	# chimeric
	if [[ ! -f "$chimeric_most_shared_tsv" ]]; then
		error "'$chimeric_most_shared_tsv' not found.\nMaybe" \
			"you need to run '$PROG_NAME chimeric' before"
	fi

	if [[ ! -f "$chimeric_info_tsv" ]]; then
		error "'$chimeric_info_tsv' not found.\nMaybe" \
			"you need to run '$PROG_NAME chimeric' before"
	fi

	# coding
	if [[ ! -f "$coding_classification_tsv" ]]; then
		error "'$coding_classification_tsv' not found.\nMaybe" \
			"you need to run '$PROG_NAME coding' before"
	fi

	# pfam
	if [[ ! -f "$pfam_info_dom_tsv" ]]; then
		error "'$pfam_info_dom_tsv' not found.\nMaybe" \
			"you need to run '$PROG_NAME pfam' before"
	fi

	# expression
	if [[ ! -f "$expression_expression_tsv" ]]; then
		error "'$expression_expression_tsv' not found.\nMaybe" \
			"you need to run '$PROG_NAME expression' before"
	fi
}

# Options
output_dir=""

# Processing variables
cod="" # Current output dir
tdir=""
string_merge_gtf=""
chimeric_most_shared_tsv=""
chimeric_info_tsv=""
coding_classification_tsv=""
pfam_info_dom_tsv=""
expression_expression_tsv=""

[[ $# == 0 ]] && { usage; exit; }

while getopts ":ho:" OPTION; do
	case "$OPTION" in
		h)
			usage
			exit
			;;
		o)
			output_dir="$OPTARG"
			;;
		?)
			error "No such option '-$OPTARG'\n$(try_help)"
			;;
	esac
done

# Check for errors in opt
validate_opt

string_merge_gtf="$output_dir/$STRING_MERGE_GTF"
chimeric_most_shared_tsv="$output_dir/$CHIMERIC_MOST_SHARED_TSV"
chimeric_info_tsv="$output_dir/$CHIMERIC_INFO_TSV"
coding_classification_tsv="$output_dir/$CODING_CLASSIFICATION_TSV"
pfam_info_dom_tsv="$output_dir/$PFAM_INFO_DOM_TSV"
expression_expression_tsv="$output_dir/$EXPRESSION_EXPRESSION_TSV"

# Check for errors in dep
validate_dep

# MAIN

# Output dir concerning this command
cod="$output_dir/$CMD_NAME"

# Create the base
mkdir -p "$cod"

# Create a temp dir
tdir=$(mktemp -d)

# Remove it automagicly
trap 'rm -rf "$tdir"' EXIT

> "$tdir/nsamplespertranscript.tsv"

log_info "Step1"
for i in $(cut -f 1 "$chimeric_most_shared_tsv" | sort -u); do
	n_samples=$(grep -w "$i" "$expression_expression_tsv" \
		| tr -t '\t' '\n' \
		| awk '{if ($1 > 0) print}' \
		| grep -v MSTRG \
		| wc -l)
	echo -e "$i\t$n_samples"
done > "$tdir/nsamplespertranscript.tsv"

log_info "Step2"
Rscript "$BIN_DIR/../scripts/median.R" \
	"$expression_expression_tsv" \
	"$cod/median.tsv" \
	|| log_error "median.R failed"

awk -F '.' '{print $0"\t"$1"."$2}' \
	"$chimeric_most_shared_tsv" \
	> "$tdir/most_shared.tsv"

#Colocar uma coluna 4 com o id_gene não so o id_trans (MSTRG.X além de MSTRG.X.Y)
log_info "Step3"
> "$tdir/host_expression"
> "$tdir/chimeric_expression"
> "$tdir/psi.tsv"

for i in $(cut -f 4 "$tdir/most_shared.tsv" | sort -u); do
	head -n1 \
		"$expression_expression_tsv" \
		> "$tdir/chimeric_expression"

	head -n1 \
		"$expression_expression_tsv" \
		> "$tdir/host_expression"

	# Redundante filtrar em most_shared lendo o próprio most_shared?
	grep -w "$i" \
		"$tdir/most_shared.tsv" \
		| cut -f 1 \
		| fgrep -wf - "$expression_expression_tsv" \
		>> "$tdir/chimeric_expression"

	grep -w "$i" "$tdir/most_shared.tsv" \
		| cut -f 2 \
		| fgrep -wf - "$string_merge_gtf" \
		| fgrep -v exon \
		| awk -F '"' '{print $4}' \
		| fgrep -wf - "$expression_expression_tsv" \
		>> "$tdir/host_expression"

	Rscript "$BIN_DIR/../scripts/psi.R" \
		"$tdir/host_expression" \
		"$tdir/chimeric_expression" \
		"$i" \
		|| log_error "psi.R failed"
done > "$tdir/psi.tsv"

echo -e 'Id\tGene\tTranscript\tEvent_in\tSamples\tExpression_Median\tPsi\tCoding(?)\tObs' \
	> "$cod/results"

join \
	<(sort -k1,1 "$tdir/most_shared.tsv") \
	<(sort -k1,1 "$chimeric_info_tsv" | cut -f 1,5) \
	| sed 's/Novel //g' \
	| join \
		- \
		<(sort -k1,1 "$tdir/nsamplespertranscript.tsv") \
	| join \
		- \
		<(sed 's/"//g' "$cod/median.tsv" | sort -k1,1) \
	| sort -k4,4 \
	| join -1 4 -2 1 \
		- \
		<(sort "$tdir/psi.tsv") \
	| sort -k2,2 \
	| join -1 2 -2 1 \
		- \
		<(sort "$coding_classification_tsv" | sort -k1,1 | awk '{if ($3 > 0.9) print $1"\tCoding"; else print $1"\tNon-Coding"}') \
	| join -a 1 \
		- \
		<(sort "$pfam_info_dom_tsv" | cut -f 1,5 | sed 's/\ /espaco/g' | sort -k1,1) \
	| awk '{$2=""; print $0}' - \
	| sed 's/\ /\t/g' \
	| sed 's/espaco/\ /g' \
	>> "$cod/results"


mkdir -p "$cod/figures"

for i in $(awk '{if ($2 >= 0.15) print $1}' "$tdir/psi.tsv" | sort -u) ; do
	head -n1 "$expression_expression_tsv" \
		> "$tdir/chimeric_expression"

	head -n1 "$expression_expression_tsv" \
		> "$tdir/host_expression"

	grep -w "$i" \
		"$chimeric_most_shared_tsv" \
		| cut -f 1 \
		| fgrep -wf - "$expression_expression_tsv" \
		>> "$tdir/chimeric_expression"

	grep -w "$i" \
		"$chimeric_most_shared_tsv" \
		| cut -f 3 \
		| fgrep -wf - "$expression_expression_tsv" \
		>> "$tdir/host_expression"

	Rscript "$BIN_DIR/../scripts/boxplot_alt.R" \
		"$tdir/host_expression" \
		"$tdir/chimeric_expression" \
		"$cod/figures/$i.svg" \
		|| log_error "boxplot_alt.R failed"
done

log_info "Done"
