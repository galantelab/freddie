#!/usr/bin/env bash

## Annotation gencode
## Prefix and RTC list (Input)
## freddie chimeric -p K562_short -i input/rtc.bed -g <gtf-path> -G <genome-path> -y default

# Bash pragmas
set -o errexit
set -o pipefail
set -o nounset

# Where I am
BIN_DIR="$(cd $(dirname $(readlink -f "${BASH_SOURCE[0]}")) && pwd)"

# Load common lib
source "$BIN_DIR/../lib/freddie_common"

# My name
SCRIPT_NAME="${0##*/}"

# Command name
CMD_NAME="${SCRIPT_NAME#${PROG_NAME}_}"

# Dep files: string
STRING_MERGE_GTF="string/merge.gtf"

usage() {
	echo "$PROG_NAME $VERSION"
	echo "$PROG_NAME $CMD_NAME (aka $SCRIPT_NAME)"
	echo "Usage: $PROG_NAME $CMD_NAME [options]"
}

validate_opt() {
	# Mandatory options '-o', '-g', '-G' and '-i'
	if [[ -z "$output_dir" ]]; then
		error "Missing '-o' option\n$(try_help)"
	elif [[ ! -d "$output_dir" ]]; then
		error "No such dir '$output_dir'.\nStart" \
			"your analysis from '$PROG_NAME string'"
	fi

	if [[ -z "$gtf" ]]; then
		error "Missing '-g' option\n$(try_help)"
	elif [[ ! -f "$gtf" ]]; then
		error "No such file '$gtf'"
	fi

	if [[ -z "$genome" ]]; then
		error "Missing '-G' option\n$(try_help)"
	elif [[ ! -f "$genome" ]]; then
		error "No such file '$genome'"
	fi

	if [[ -z "$input" ]]; then
		error "Missing '-i' option\n$(try_help)"
	elif [[ ! -f "$input" ]]; then
		error "No such file '$input'"
	fi

	# Options
	if [[ ! "$type" =~ ^(strict|default)$ ]]; then
		error "'$type' is not a valid '-y' option\n$(try_help)"
	fi
}

validate_dep() {
	# O merge.gtf deve ser passado pelo usuário ou
	# ser localizado pelo output_dir e prefix?
	#
	# string
	if [[ ! -f "$string_merge_gtf" ]]; then
		error "'$string_merge_gtf' not found.\nMaybe" \
			"you need to run '$PROG_NAME string' before"
	fi
}

# Options
output_dir=""
input="" # BED?
gtf="" # Pode ser gff?
genome=""
type="default"

# Processing variables
cod="" # Current output dir
tdir=""
paramet=""
string_merge_gtf=""

[[ $# == 0 ]] && { usage; exit; }

while getopts ":ho:i:g:G:y:" OPTION; do
	case "$OPTION" in
		h)
			usage
			exit
			;;
		o)
			output_dir="$OPTARG"
			;;
		i)
			input="$OPTARG"
			;;
		g)
			gtf="$OPTARG"
			;;
		G)
			genome="$OPTARG"
			;;
		y)
			type="$OPTARG"
			;;
		?)
			error "No such option '-$OPTARG'\n$(try_help)"
			;;
	esac
done

# Check for errors in opt
validate_opt

# Set the dep files paths
string_merge_gtf="$output_dir/$STRING_MERGE_GTF"

# Check for errors in dep
validate_dep

# MAIN

if [[ "$type" == "strict" ]]; then
	paramet='-r'
fi

# Output dir concerning this command
cod="$output_dir/$CMD_NAME"

# Create the base
mkdir -p "$cod"

# Create a temp dir
tdir=$(mktemp -d)

# Remove it automagicly
trap 'rm -rf "$tdir"' EXIT

log_info 'Finding new transcripts'

# Dicionário de protein codings
awk '{if ($3 == "CDS") print $10}' "$gtf" \
	| sed 's/;\|"//g' \
	| cut -d . -f 1 \
	| sort -u \
	| fgrep -f - "$string_merge_gtf" \
	| awk -F'"' '{print $2}' \
	| sort -u \
	| cut -d . -f 1 > "$tdir/dic.txt"

#Filtro de transcritos anotados
fgrep "transcript_id \"MSTRG" \
	"$string_merge_gtf" > "$cod/novels.gtf"

#Pegando os exons dos novos transcritos
awk -F "\t" '{if ($3 == "exon" && $1 ~/chr/) print $1"\t"$4"\t"$5"\t"$9}' \
	"$cod/novels.gtf" \
	| sort -k1,1 -k2,2n \
	> "$tdir/novels_exon.bed"

#Lista dos transcritos novos que tem RTC
log_info 'Finding chimeric transcripts'
bedtools intersect "$paramet" -f 0.5 -wo \
	-a "$input" \
	-b "$tdir/novels_exon.bed" \
	| cut -f 4,8 \
	| awk -v OFS="\t" '{print $5,$7,"\""$1"\""}' \
	| sed 's/"\|;//g' \
	| sort -u \
	| awk -v OFS="\t" '{print $1,$2,$2,$3}' \
	| sort -k1,1 -k2,2n \
	| bedtools merge -o collapse -i - -c 4 \
	| awk -v OFS="\t" '{if ($3-$2==2) print $1,$2+1,$NF; else if ($3-$2<2) print $1,$2,$NF}' \
	> "$cod/chimeric.txt"

#Montando um gtf dos transcritos novos anotados pelo stringtie
fgrep -w \
	-f <(cut -f 1 "$cod/chimeric.txt") \
	"$string_merge_gtf" \
	> "$cod/protein.gtf"

#Montando um gtf e um bed com possiveis transcritos quiméricos
grep -w \
	-f "$tdir/dic.txt" \
	"$cod/protein.gtf" \
	> "$tdir/chimeric_dic.gtf"

grep -w exon \
	"$tdir/chimeric_dic.gtf" \
	| cut -f 1,4,5,9 \
	> "$tdir/exon.bed"

#Criando um bed com todos os transcritos ja anotados de protein_coding
awk '{if ($3 == "CDS") print $12}' "$gtf" \
	| sed 's/;\|"//g' \
	| sort -u \
	| fgrep -wf - "$gtf" \
	| awk '{if ($3 == "exon") print}' \
	| cut -f 1,4,5,9 \
	| bedtools intersect -wo -a "$tdir/exon.bed" -b - \
	| cut -f 4,8 \
	| awk -F '"' '{print $4"\t"$8"\t"$10}' \
	| sort \
	| uniq -c \
	| sort -k2,2 -k1,1r \
	> "$tdir/partial.tsv"

> "$cod/most_shared.tsv"
fgrep MSTRG "$tdir/partial.tsv" \
	| awk -v OFS="\t" '{if ($1 > 1) print $1,$2,$3,$4}' \
	| sort -k2,2 -k1,1nr \
	| awk '!D[$2]++' \
	| awk '{print $1,$2}' \
	| fgrep -wf - "$tdir/partial.tsv" \
	| awk -F" " '{print $2"\t"$3"\t"$4}' \
	> "$cod/most_shared.tsv"

fgrep -w \
	-f <(cut -f 1 "$cod/most_shared.tsv" | sort -u) \
	"$cod/protein.gtf" \
	> "$tdir/chimeric.gtf"

#Classificando internal initial e final
python3 "$BIN_DIR/../scripts/bed_novel.py" \
	"$tdir/chimeric.gtf" \
	> "$tdir/info_bed_novel.txt" \
	|| log_error "'bed_novel.py' returned an error"

sed 's/\\//g' "$cod/chimeric.txt" \
	> "$tdir/joined.txt"

join \
	<(sort -k1,1 -k2,2n "$tdir/info_bed_novel.txt") \
	<(sort -k1,1 -k2,2n "$tdir/joined.txt") \
	| awk -F " " '{if ($3 == $4 && $2 == "+") print $1"\t"$2"\t"$3"\t"$4"\tNovel Final"; \
		else if ($3 == $4 && $2 == "-") print $1"\t"$2"\t"$3"\t"$4"\tNovel Initial"; \
		else if ($4 == 1 && $2 == "+") print $1"\t"$2"\t"$3"\t"$4"\tNovel Initial"; \
		else if ($4 == 1 && $2 == "-") print $1"\t"$2"\t"$3"\t"$4"\tNovel Final"; \
		else print $1"\t"$2"\t"$3"\t"$4"\tNovel Internal"}' \
	> "$tdir/info.tsv"

grep -v \
	-f <(cut -f 1 "$tdir/info.tsv" \
	| uniq -c \
	| awk '{if ($1 > 1) print $2}') "$tdir/info.tsv" \
	> "$cod/info.tsv"

grep \
	-f <(cut -f 1,4 "$tdir/info.tsv" \
	| uniq -c \
	| awk '{if ($1 > 1) print $2}') "$tdir/info.tsv" \
	>> "$cod/info.tsv"

cut -f 1 "$cod/info.tsv" \
	| fgrep -wf - "$tdir/chimeric.gtf" \
	| awk -F \" '{print $4"\t"$0}' \
	| sort -k1,1 -k4,4r \
	| join - <(sort -k1,1 "$cod/chimeric.txt") \
	| awk -v OFS="\t" -F ' ' '{if ($4 == "transcript") print $2,$3,$4,$5,$6,$7,$8,$9,$10" "$11" "$12" "$13" chimeric_event \""$15"\"; chimeric_exon_number \""$14"\";"; \
		else print$2,$3,$4,$5,$6,$7,$8,$9,$10" "$11" "$12" "$13" "$14" "$15}' \
	> "$cod/chimeric.gtf"

#Arquivo fasta dos possiveis transcritos quimericos do stringtie
gffread "$cod/chimeric.gtf" \
	-g "$genome" \
	-w "$cod/chimeric.fasta" \
	2> "$cod/chimeric.fasta.log" \
	|| log_error \
		"gffread failed:" \
		"See '$(readlink -f "$cod/chimeric.fasta.log")'" \
		"for more details"

log_info "Done"
